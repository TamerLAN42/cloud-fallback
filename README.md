# Cloud-fallback
Это набор скриптов и конфигов для аварийного переноса приложения (в качестве примера используется nginx) на автоматически-арендуемую у яндекс-облака ВМ.  
Изначальная задумка - обеспечить приложению облачную устойчивость при минимальных денежных затратах. В стабильные времена приложение спокойно крутится на локальном железе, а в случае инцидента в автоматическом режиме переносит всё что удастся в облако.  
Для начала работы понадобится 2 независимых хост-машины, 2 пары ssh-ключей типа ed25519 и ключ доступа к сервисному аккаунту яндекс облака (авторизованный ключ или IAM-токен). По всем пунктам я отдельно пройдусь по ходу инструкции, кроме хост-машин. Их-уж готовьте сами

Репозиторий содержит 2 компонента. Они запускаются раздельно, на разных машинах, но чтобы не запутать ни себя, ни вас, всё содержится в одном репозитории.  

## Быстрый старт
1. Перед тем как приступать к заполнению конфигов, надо склонировать репозиторий на оба сервера. Напоминаю, репозиторий содержит все компоненты, поэтому на этом этапе нам без разницы какой сервер за что отвечает.
```bash
git clone https://github.com/TamerLAN42/cloud-fallback.git
```  
2. Далее нам необходимо создать 2 пары ssh ключей типа `ed25519` (хватит пользоваться rsa, у меня кончается место на диске из-за него)  
Выполняем команду на любом ПК с ssh-клиентом, и сразу переименовываем ключи для удобства восприятия.  
На всякий случай я это уточню - не указывайте пароль к ключам. Скрипты очень не любят интерактивный ввод
```bash
ssh-keygen -t ed25519 -C "Ваш-остроумный-комментарий" -f ./id_backup
ssh-keygen -t ed25519 -C "Ещё-более-остроумный-комментарий" -f ./id_cloud
```  
3. Теперь распределяем ключи. Для самых ленивых - просто продублируйте все 4 штуки в папки `keys` и на основном хосте и на бекап-хосте, и это будет работать.  
Если у вас дома дверь с семью замками - `id_backup` переместите в папку `keys` на основном хосте, а все остальные ключи в папку `keys` на бекап-хосте.

4. Также нам понадобится ключ от сервисного аккаунта yandex.cloud. Это несвободный сервис, поэтому как это сделать на текущий момент знает только документация яндекс облака.  
А я только намекну - нам нужен .json файл с авторизованным ключом от сервисного аккаунта с достаточными правами для создания ресурсов.  
Имеющийся ключ кладём на бекап-хост в папку `keys` к остальным ключам, убедитесь что он называется `key.json`.

5. Далее - настройка конфигов. По факту всё сводится к указанию ваших параметров в docker-compose.yml на обоих хостах  
Обязательные переменные основного хоста: 
- `BACKUP_HOST` - содержащий ip или домен бекап-хоста

Обязательные переменные бекап хоста:
- `TF_VAR_cloud_id` - id вашего облака в яндексе, узнать можно в консоли console.yandex.cloud в самой верхней части экрана.
- `TF_VAR_folder_id` - id фолдера в облаке. Находится точно там-же, справа от id облака.
А также одно из двух, либо:
- `CHECK_HOST` - Домен или айпи для мониторинга. Без протоколов.
- `CHECK_PORT` - Порт сервиса который будем мониторить.
Либо:
- `CHECK_URL` - Полный url сервиса для мониторинга, включая протокол и порт. Например `https://example.orp:123`

6. После того как обязательные переменные установлены, можно приступать к запуску.  
Обратите внимание, у компонентов зависимость друг от друга, поэтому запустить их надо +- одновременно. Речь идёт о интервале менее чем 10-20-30 секунд. Будет хорошо, если сервис для мониторинга на основном хосте запустится прежде, чем бекап-хост признает его мёртвым.  
Производим `docker-compose up -d` на обоих хостах, находясь в соответствующих директориях, с не слишком большим интервалом.  
Готово, сервис запущен, данные бекапируются, а в случае инцидента последний сохраненный экземпляр будет использован для запуска реплики в яндекс облаке. Можете взять печеньку.  
После отработки скрипта, когда основной сервис восстановит свою доступность, а все нужные данные с созданной ВМ будут перенесены - просто удалите `LOCK_STATE` в директории `./shared`, и мониторинг продолжится в штатном режиме, готовый вновь спасти сервис от падения.  
**На всякий случай**, я продублирую: При удалении `LOCK_STATE` запустится процесс удаления созданной ВМ в яндекс облаке. Не удаляйте файл до того, как перенесёта с ВМ всё что вам нужно.  

## Структура проекта
Как и говорилось, он состоит из двух компонентов - 
- `./host` - компонент для работы основного сервиса. Он посылает бекапы на указанный адрес и готовится стать жертвой инцидента.
- `./backup-host` - компонент для работы бекап-сервера, он-же сервер-последнего-шанса. Он принимает и хранит бекап, опрашивает основной хост о его состоянии и готовится отправить всё в облако при инциденте.
